{% extends "dashboard.html" %}

{% block title %}Weekly Planner - Gym Planner{% endblock %}

{% block main_content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
    <div class="mt-4 text-center text-md-start">
        <h1>Your Weekly Planner</h1>
        <span class="fs-5 text-muted">
            {{ start_of_week.strftime('%B %d, %Y') }} - {{ (start_of_week + timedelta(days=6)).strftime('%B %d, %Y')
            }}
        </span>
    </div>
    <div class="mt-4">
        <div id="navigation-controls"
            class="d-flex flex-column flex-sm-row align-items-stretch align-items-sm-center justify-content-end gap-2">
            <form id="navigation-form" class="d-flex flex-column flex-sm-row gap-2">
                <select id="year-select" name="year" class="form-select form-select-sm" style="width: auto;">
                    {% for year in year_range %}
                    <option value="{{ year }}" {% if year==selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
                <select id="month-select" name="month" class="form-select form-select-sm" style="width: auto;">
                    {% for month_name in month_names %}
                    <option value="{{ loop.index }}" {% if loop.index==selected_month %}selected{% endif %}>{{
                        month_name }}
                    </option>
                    {% endfor %}
                </select>
                <select id="week-select" name="week" class="form-select form-select-sm" style="width: auto;">
                    {% for week_num in range(1, num_weeks_in_month + 1) %}
                    <option value="{{ week_num }}" {% if week_num==selected_week_in_month %}selected{% endif %}>
                        Week {{ week_num }}
                    </option>
                    {% endfor %}
                </select>
                <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">Today</a>
            </form>
            <!-- "Copy Last Week" Logic -->
            {% if has_previous_week_workouts %}
            <form method="POST" action="{{ url_for('copy_last_week') }}" class="d-block">
                <input type="hidden" name="current_week_start_date" value="{{ start_of_week.isoformat() }}">
                <button type="submit" class="btn btn-sm btn-outline-info"
                    title="Copy the plan from the previous week to this week. This will overwrite any existing exercises in the current week.">Copy
                    Last Week</button>
            </form>
            {% else %}
            <button type="button" class="btn btn-sm btn-outline-info disabled"
                title="No workouts found in the previous week to copy.">Copy Last Week</button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Weekly Goals Panel -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">This Week's Goals</h5>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                data-bs-target="#manageGoalsModal">Manage Goals</button>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            {% for muscle, progress in weekly_goals_progress.items()|sort %}
            <div class="col-6 col-md-4 col-lg-3 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="goal-{{ muscle }}" {% if progress.current>=
                    progress.target %}checked{% endif %} disabled>
                    <label class="form-check-label" for="goal-{{ muscle }}">
                        Train {{ muscle }}: {{ [progress.current, progress.target]|min }} / {{ progress.target }}
                    </label>
                </div>
            </div>
            {% else %}
            <p class="text-muted">No weekly goals have been set up.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Progress Snapshot Panel -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Progress Snapshot</h5>
            <a href="{{ url_for('progress_tracker') }}" class="btn btn-sm btn-outline-secondary">View Full Report</a>
        </div>
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <h6 class="text-muted">Total Weight Lifted</h6>
                        <p class="fs-4 fw-bold mb-0">{{ "%.0f"|format(progress_snapshot.current_week_volume) }} kg</p>
                    </div>
                    <div>
                        <h6 class="text-muted">vs. Last Week</h6>
                        {% if progress_snapshot.percentage_change > 0 %}
                        <p class="fs-4 fw-bold text-success mb-0">
                            +{{ progress_snapshot.percentage_change }}%
                        </p>
                        {% elif progress_snapshot.percentage_change < 0 %} <p class="fs-4 fw-bold text-danger mb-0">
                            {{ progress_snapshot.percentage_change }}%
                            </p>
                            {% else %}
                            <p class="fs-4 fw-bold text-muted mb-0">
                                --
                            </p>
                            {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                {% if progress_snapshot.volume_trend.data %}
                <canvas id="volumeTrendChart" style="max-height: 100px;"></canvas>
                {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-center">
                    <p class="text-muted">
                        Log workouts with weight and reps to see your volume trend.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<div class="row">
    {% for day, workout in week_plan.items() %}
    <div class="col-12 col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{{ day }} - <span class="text-primary">{{ workout.title if workout and
                            workout.title else ('Rest Day' if day == 'Sunday' or (workout and workout.is_rest_day) else
                            'No Title') }}</span></h5>
                    <small class="text-muted">
                        {{ (start_of_week + timedelta(days=loop.index0)).strftime('%B %d') }}
                    </small>
                </div>
            </div>
            <div class="card-body">
                {% if workout and not workout.is_rest_day and day != 'Sunday' %}
                {% if workout.tasks %}
                <!-- Progress Bar (now based on sets) -->
                {% set total_sets = namespace(count=0) %}
                {% set completed_sets = namespace(count=0) %}
                {% for task in workout.tasks %}
                {% if task.sets is iterable and (task.sets is not string and task.sets is not mapping) %}
                {% set total_sets.count = total_sets.count + (task.sets|length) %}
                {% for s in task.sets %}{% if s.completed %}{% set completed_sets.count = completed_sets.count + 1 %}{%
                endif %}{% endfor %}
                {% endif %}
                {% endfor %}
                {% set progress = (completed_sets.count / total_sets.count * 100) if total_sets.count > 0 else 0 %}
                <div class="progress mb-3" style="height: 20px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ progress }}%;"
                        aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">{{ completed_sets.count }}
                        / {{
                        total_sets.count }}</div>
                </div>

                <ul class="list-group list-group-flush">
                    {% for task in workout.tasks %}
                    <li class="list-group-item bg-transparent">
                        {% if task.sets is iterable and (task.sets is not string and task.sets is not mapping) %}
                        {# New data structure: 'sets' is a list of objects #}
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <strong>{{ task.exercise_name }}</strong>: {{ task.sets|length }} sets of {{
                                task.target_reps }} reps {% if task.rest_time %}({{ task.rest_time }} rest){% endif %}
                            </span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary edit-exercise-btn"
                                    data-bs-toggle="modal" data-bs-target="#editExerciseModal"
                                    data-workout-id="{{ workout._id }}" data-task-id="{{ task._id }}"
                                    data-exercise-id="{{ task.exercise_id }}" data-sets="{{ task.sets|length }}"
                                    data-reps="{{ task.target_reps }}" data-rest-time="{{ task.rest_time or '' }}"
                                    data-notes="{{ task.notes or '' }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-task-btn" data-bs-toggle="modal"
                                    data-bs-target="#deleteConfirmationModal" data-workout-id="{{ workout._id }}"
                                    data-task-id="{{ task._id }}">
                                    <i class="fas fa-trash-alt"></i> Delete</button>
                            </div>
                        </div>
                        {% if task.notes %}
                        <div class="ps-4 mt-1">
                            <small class="text-muted fst-italic">Notes: {{ task.notes }}</small>
                        </div>
                        {% endif %}
                        <ul class="list-group list-group-flush mt-2">
                            {% for set_item in task.sets %}
                            <li class="list-group-item bg-transparent d-flex align-items-center ps-4">
                                <div
                                    class="d-flex flex-column flex-sm-row align-items-stretch align-items-sm-center w-100">
                                    <span class="me-3 mb-2 mb-sm-0">Set {{ set_item.set_number }}</span>
                                    <div class="input-group input-group-sm me-sm-2 mb-2 mb-sm-0 flex-grow-1">
                                        <input type="text" class="form-control set-detail-input" placeholder="Weight"
                                            data-field="weight_kg" value="{{ set_item.weight_kg or '' }}"
                                            data-workout-id="{{ workout._id }}" data-task-id="{{ task._id }}"
                                            data-set-id="{{ set_item._id }}">
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    <div class="input-group input-group-sm me-sm-auto flex-grow-1">
                                        <input type="text" class="form-control set-detail-input" placeholder="Reps"
                                            data-field="actual_reps" value="{{ set_item.actual_reps or '' }}"
                                            data-workout-id="{{ workout._id }}" data-task-id="{{ task._id }}"
                                            data-set-id="{{ set_item._id }}">
                                        <span class="input-group-text">reps</span>
                                    </div>
                                    <input class="form-check-input ms-sm-3" type="checkbox"
                                        data-workout-id="{{ workout._id }}" data-task-id="{{ task._id }}"
                                        data-set-id="{{ set_item._id }}" {% if set_item.completed %}checked{% endif %}>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        {# Old data structure: 'sets' is an integer #}
                        <strong>{{ task.exercise_name }}</strong>: {{ task.sets }} sets of {{ task.reps }} reps
                        <p class="text-muted small ps-4"> (Old format, please re-add to track individual sets) </p>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No exercises scheduled.</p>
                {% endif %}
                {% elif day == 'Sunday' or (workout and workout.is_rest_day) %}
                <p class="text-success fw-bold">Rest Day</p>
                {% if workout and workout.notes %}
                <div class="fst-italic text-muted border-top pt-2 mt-2">
                    <strong>Notes:</strong> {{ workout.notes }}
                </div>
                {% endif %}
                {% else %}
                <p class="text-muted">No exercises scheduled.</p>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="d-flex flex-wrap gap-2">
                    <!-- "Edit Day" button is available for all days to add notes or set rest day status -->
                    <button class="btn btn-sm btn-outline-secondary edit-day-btn" data-bs-toggle="modal"
                        data-bs-target="#editDayModal"
                        data-date="{{ (start_of_week + timedelta(days=loop.index0)).isoformat() }}"
                        data-notes="{{ workout.notes if workout else '' }}"
                        data-title="{{ workout.title if workout else '' }}"
                        data-is-rest-day="{{ 'true' if day == 'Sunday' or (workout and workout.is_rest_day) else 'false' }}">Edit
                        Day</button>

                    <!-- "Add" button is only available for non-Sundays -->
                    {% if day != 'Sunday' %}
                    <button class="btn btn-sm btn-outline-primary add-exercise-btn" data-bs-toggle="modal"
                        data-bs-target="#addExerciseModal"
                        data-date="{{ (start_of_week + timedelta(days=loop.index0)).isoformat() }}">Add</button>

                    <button class="btn btn-sm btn-outline-success copy-day-btn" data-bs-toggle="modal"
                        data-bs-target="#copyDayModal" data-source-workout-id="{{ workout._id if workout else '' }}"
                        data-source-date="{{ (start_of_week + timedelta(days=loop.index0)).strftime('%A, %b %d') }}" {%
                        if not workout or not workout.tasks %}disabled{% endif %}
                        title="Copy this day's workout to another date">Copy</button>

                    <button class="btn btn-sm btn-outline-warning expert-plan-btn" data-bs-toggle="modal"
                        data-bs-target="#expertPlanModal"
                        data-date="{{ (start_of_week + timedelta(days=loop.index0)).isoformat() }}">Expert Plan</button>

                    <button class="btn btn-sm btn-outline-danger clear-day-btn" data-bs-toggle="modal"
                        data-bs-target="#clearDayModal"
                        data-date="{{ (start_of_week + timedelta(days=loop.index0)).isoformat() }}"
                        data-day-name="{{ day }}" {% if not workout or not workout.tasks %}disabled{% endif %}>Clear
                        Day</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock main_content %}

{% block body_end_scripts %}
{{ super() }}
<!-- Clear Day Confirmation Modal -->
<div class="modal fade" id="clearDayModal" tabindex="-1" aria-labelledby="clearDayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('clear_workout_day') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="clearDayModalLabel">Confirm Clear Day</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="clear_workout_date" id="clear_workout_date">
                    <p>Are you sure you want to delete all exercises for <strong id="clear-day-name-display"></strong>?
                        This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Clear All Exercises</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Expert Plan Modal -->
<!-- Manage Weekly Goals Modal -->
<div class="modal fade" id="manageGoalsModal" tabindex="-1" aria-labelledby="manageGoalsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('update_weekly_goals') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageGoalsModalLabel">Manage Weekly Goals</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Set how many times you want to train each muscle group per week. Set to 0 to not track.</p>
                    <div class="row">
                        {% for muscle in all_muscle_groups %}
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <span class="input-group-text" style="width: 120px;">{{ muscle }}</span>
                                <input type="number" class="form-control" name="goal_{{ muscle }}"
                                    value="{{ user_weekly_goals.get(muscle, 0) }}" min="0" max="7">
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted">No muscle groups found. Add exercises to the library first.</p>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Goals</button>
                </div>
            </form>
        </div>
    </div>
</div>



<!-- Expert Plan Modal -->
<div class="modal fade" id="expertPlanModal" tabindex="-1" aria-labelledby="expertPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('apply_expert_plan') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="expertPlanModalLabel">Apply an Expert Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="expert_plan_date" id="expert_plan_date">
                    <p>Choose a plan to apply. This will <strong class="text-danger">overwrite</strong> any existing
                        exercises for the selected day.</p>
                    <div class="mb-3">
                        <label for="expert_plan_name" class="form-label">Available Plans</label>
                        <select class="form-select" name="expert_plan_name" id="expert_plan_name" required>
                            <option selected disabled value="">Choose a plan...</option>
                            {% for plan_name in expert_plans.keys()|sort %}
                            <option value="{{ plan_name }}">{{ plan_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Apply Plan</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Copy Day Modal -->
<div class="modal fade" id="copyDayModal" tabindex="-1" aria-labelledby="copyDayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('copy_day') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="copyDayModalLabel">Copy Workout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="source_workout_id" id="source_workout_id">
                    <p>Copying workout from <strong id="source-date-display"></strong>.</p>
                    <div class="mb-3">
                        <label for="target_date" class="form-label">Select date to copy to:</label>
                        <input type="date" class="form-control" name="target_date" id="target_date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Copy to Date</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Edit Day Modal -->
<div class="modal fade" id="editDayModal" tabindex="-1" aria-labelledby="editDayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('edit_workout_day') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="editDayModalLabel">Edit Day</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="edit_workout_date" id="edit_workout_date">
                    <div class="mb-3">
                        <label for="day_title" class="form-label">Day Title (e.g., Push Day, Leg Day)</label>
                        <input type="text" class="form-control" name="day_title" id="day_title"
                            placeholder="e.g., Leg Day">
                    </div>
                    <div class="mb-3">
                        <label for="day_notes" class="form-label">Notes for the day (optional)</label>
                        <textarea class="form-control" name="day_notes" id="day_notes" rows="3"
                            placeholder="e.g., Felt tired, focused on form..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_rest_day" id="is_rest_day">
                        <label class="form-check-label" for="is_rest_day">
                            Mark as Rest Day
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>



<!-- Add Exercise Modal -->
<div class="modal fade" id="addExerciseModal" tabindex="-1" aria-labelledby="addExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_exercise_to_day') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="addExerciseModalLabel">Add Exercise</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="workout_date" id="workout_date">
                    <div class="mb-3">
                        <label for="exercise_id" class="form-label">Exercise</label>
                        <select class="form-select" name="exercise_id" id="exercise_id" required>
                            <option selected disabled value="">Choose...</option>
                            {% for exercise in all_exercises %}
                            <option value="{{ exercise._id }}">{{ exercise.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sets" class="form-label">Sets</label>
                        <input type="number" class="form-control" name="sets" id="sets" required>
                    </div>
                    <div class="mb-3">
                        <label for="reps" class="form-label">Reps</label>
                        <input type="text" class="form-control" name="reps" id="reps" placeholder="e.g., 8-12" required>
                    </div>
                    <div class="mb-3">
                        <label for="rest_time" class="form-label">Rest Time (optional)</label>
                        <input type="text" class="form-control" name="rest_time" id="rest_time"
                            placeholder="e.g., 90s, 2min">
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" name="notes" id="notes" rows="2"
                            placeholder="e.g., Increase weight next time"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Exercise</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Exercise Modal -->
<div class="modal fade" id="editExerciseModal" tabindex="-1" aria-labelledby="editExerciseModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('edit_exercise') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="editExerciseModalLabel">Edit Exercise</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="edit_workout_day_id" id="edit_workout_day_id">
                    <input type="hidden" name="edit_task_id" id="edit_task_id">
                    <div class="mb-3">
                        <label for="edit_exercise_id" class="form-label">Exercise</label>
                        <select class="form-select" name="edit_exercise_id" id="edit_exercise_id" required>
                            <option disabled value="">Choose...</option>
                            {% for exercise in all_exercises %}
                            <option value="{{ exercise._id }}">{{ exercise.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_sets" class="form-label">Sets</label>
                        <input type="number" class="form-control" name="edit_sets" id="edit_sets" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_reps" class="form-label">Reps</label>
                        <input type="text" class="form-control" name="edit_reps" id="edit_reps" placeholder="e.g., 8-12"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_rest_time" class="form-label">Rest Time (optional)</label>
                        <input type="text" class="form-control" name="edit_rest_time" id="edit_rest_time"
                            placeholder="e.g., 90s, 2min">
                    </div>
                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" name="edit_notes" id="edit_notes" rows="2"
                            placeholder="e.g., Focus on form"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this exercise? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Toast Notification Helper ---
        function showToast(message, category = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) return;

            const categoryMap = {
                'success': 'bg-success',
                'danger': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            };
            const toastClass = categoryMap[category] || 'bg-secondary';

            const toastWrapper = document.createElement('div');
            toastWrapper.innerHTML = `
                <div class="toast align-items-center text-white ${toastClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            const toastEl = toastWrapper.firstChild;
            toastContainer.appendChild(toastEl);
            new bootstrap.Toast(toastEl, { delay: 5000 }).show();
        }

        var addExerciseModal = document.getElementById('addExerciseModal');
        addExerciseModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var workoutDate = button.getAttribute('data-date'); // Extract info from data-* attributes
            var modalDateField = addExerciseModal.querySelector('#workout_date');
            modalDateField.value = workoutDate;
        });

        var editDayModal = document.getElementById('editDayModal');
        editDayModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var workoutDate = button.getAttribute('data-date');
            var currentTitle = button.getAttribute('data-title');
            var currentNotes = button.getAttribute('data-notes');
            var isRestDay = button.getAttribute('data-is-rest-day') === 'true';

            var modalDateField = editDayModal.querySelector('#edit_workout_date');
            var modalTitleField = editDayModal.querySelector('#day_title');
            var modalNotesField = editDayModal.querySelector('#day_notes');
            var modalRestDayCheckbox = editDayModal.querySelector('#is_rest_day');
            var modalTitleInput = editDayModal.querySelector('#day_title');

            // For Sunday, disable the title input as it's always a rest day
            if (new Date(workoutDate).getUTCDay() === 0) { // JS getUTCDay() is 0 for Sunday, 6 for Saturday.
                modalTitleInput.disabled = true;
            } else {
                modalTitleInput.disabled = false;
            }

            modalDateField.value = workoutDate;
            modalTitleField.value = currentTitle;
            modalNotesField.value = currentNotes;
            modalRestDayCheckbox.checked = isRestDay;
        });

        var copyDayModal = document.getElementById('copyDayModal');
        copyDayModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var sourceWorkoutId = button.dataset.sourceWorkoutId;
            var sourceDate = button.dataset.sourceDate;

            copyDayModal.querySelector('#source_workout_id').value = sourceWorkoutId;
            copyDayModal.querySelector('#source-date-display').textContent = sourceDate;
        });

        var expertPlanModal = document.getElementById('expertPlanModal');
        expertPlanModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var workoutDate = button.getAttribute('data-date');
            expertPlanModal.querySelector('#expert_plan_date').value = workoutDate;
        });

        var editExerciseModal = document.getElementById('editExerciseModal');
        editExerciseModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            // Populate hidden fields
            document.getElementById('edit_workout_day_id').value = button.dataset.workoutId;
            document.getElementById('edit_task_id').value = button.dataset.taskId;

            // Populate visible form fields
            document.getElementById('edit_exercise_id').value = button.dataset.exerciseId;
            document.getElementById('edit_sets').value = button.dataset.sets;
            document.getElementById('edit_reps').value = button.dataset.reps;
            document.getElementById('edit_rest_time').value = button.dataset.restTime;
            document.getElementById('edit_notes').value = button.dataset.notes;
        });

        var clearDayModal = document.getElementById('clearDayModal');
        clearDayModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var workoutDate = button.dataset.date;
            var dayName = button.dataset.dayName;
            clearDayModal.querySelector('#clear_workout_date').value = workoutDate;
            clearDayModal.querySelector('#clear-day-name-display').textContent = dayName;
        });





        // Handle set completion checkboxes
        document.querySelectorAll('.form-check-input[data-set-id]').forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                const workoutId = this.dataset.workoutId;
                const taskId = this.dataset.taskId;
                const setId = this.dataset.setId;
                const isCompleted = this.checked;

                // Update progress bar immediately
                const cardBody = this.closest('.card');
                const progressBar = cardBody.querySelector('.progress-bar'); // This might be null if no tasks
                const allCheckboxes = cardBody.querySelectorAll('.set-checkbox');
                const totalSets = allCheckboxes.length;
                const completedSets = Array.from(allCheckboxes).filter(cb => cb.checked).length;
                const newProgress = totalSets > 0 ? (completedSets / totalSets * 100) : 0;

                progressBar.style.width = newProgress + '%';
                progressBar.textContent = `${completedSets} / ${totalSets}`;
                if (progressBar) {
                    progressBar.setAttribute('aria-valuenow', newProgress);
                }

                // Send update to the server
                fetch("{{ url_for('toggle_set_completion') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        workout_day_id: workoutId,
                        task_id: taskId,
                        set_id: setId,
                        is_completed: isCompleted
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status !== 'success') {
                            console.error('Failed to update set:', data.message);
                            // Optional: revert checkbox and show an error message
                            this.checked = !isCompleted;
                            // You might want to re-calculate and update the progress bar here as well
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        });

        // Handle task deletion
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        let workoutIdToDelete, taskIdToDelete;

        // 1. When the modal is about to be shown, store the relevant IDs
        deleteConfirmationModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Button that triggered the modal
            workoutIdToDelete = button.dataset.workoutId;
            taskIdToDelete = button.dataset.taskId;
        });

        // 2. When the confirm delete button is clicked, perform the fetch
        confirmDeleteBtn.addEventListener('click', function () {
            fetch("{{ url_for('delete_task') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    workout_day_id: workoutIdToDelete,
                    task_id: taskIdToDelete,
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Find the task item in the DOM and remove it
                        const taskListItem = document.querySelector(`.delete-task-btn[data-task-id="${taskIdToDelete}"]`).closest('.list-group-item');
                        if (taskListItem) {
                            taskListItem.remove();
                        }
                        // Hide the modal
                        const modal = bootstrap.Modal.getInstance(deleteConfirmationModal);
                        modal.hide();
                        showToast('Exercise deleted successfully.', 'success');
                    } else {
                        console.error('Failed to delete task:', data.message);
                        showToast('Error: Could not delete the exercise.', 'danger');
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    });

    // Handle set detail input (weight/reps)
    document.querySelectorAll('.set-detail-input').forEach(function (input) {
        let debounceTimer;
        input.addEventListener('input', function () {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const workoutId = this.dataset.workoutId;
                const taskId = this.dataset.taskId;
                const setId = this.dataset.setId;
                const field = this.dataset.field;
                const value = this.value;

                fetch("{{ url_for('update_set_details') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        workout_day_id: workoutId,
                        task_id: taskId,
                        set_id: setId,
                        [field]: value
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Reload to update weekly goals progress.
                            window.location.reload();
                        }
                    }).catch(err => console.error(err));
            }, 1000); // Wait 1 second after user stops typing
        });
    });

    // --- New Navigation Script ---
    document.addEventListener('DOMContentLoaded', function () {
        const yearSelect = document.getElementById('year-select');
        const monthSelect = document.getElementById('month-select');
        const weekSelect = document.getElementById('week-select');

        // Minor fix for JS date logic to match Python's week start on Monday
        // In JS, Sunday is 0. In Python, Monday is 0. We need to adjust.
        Date.prototype.getWeekDay = function () {
            // Returns Monday = 0, ..., Sunday = 6
            return (this.getDay() + 6) % 7;
        };

        function navigate() {
            const year = yearSelect.value;
            const month = monthSelect.value;
            const week = weekSelect.value;
            // When year or month changes, default to week 1
            const weekQuery = event.target.id !== 'week-select' ? 1 : week;
            window.location.href = `{{ url_for('dashboard') }}?year=${year}&month=${month}&week=${weekQuery}`;
        }

        yearSelect.addEventListener('change', navigate);
        monthSelect.addEventListener('change', navigate);
        weekSelect.addEventListener('change', navigate);
    });

    // --- Progress Snapshot Chart ---
    document.addEventListener('DOMContentLoaded', function () {
        const snapshotData = {{ json_dumps(progress_snapshot.volume_trend) | safe
    }};
    const trendCtx = document.getElementById('volumeTrendChart');

    if (trendCtx && snapshotData.data.length > 0) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: snapshotData.labels,
                datasets: [{
                    label: 'Total Weight Lifted (kg)',
                    data: snapshotData.data,
                    fill: true,
                    backgroundColor: 'rgba(3, 218, 198, 0.2)',
                    borderColor: 'rgba(3, 218, 198, 1)',
                    tension: 0.3,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: { display: false, beginAtZero: true },
                    x: { display: false }
                }
            }
        });
    }
    });

</script>
{% endblock %}