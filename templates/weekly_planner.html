{% extends "dashboard.html" %}

{% block title %}Weekly Planner - Gym Planner{% endblock %}

{% block main_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mt-4">Your Weekly Planner</h1>
    <span class="fs-5 text-muted">
        {{ start_of_week.strftime('%B %d, %Y') }} - {{ (start_of_week + timedelta(days=6)).strftime('%B %d, %Y')
        }}
    </span>
</div>

<div class="row">
    {% for day, workout in week_plan.items() %}
    <div class="col-12 col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{{ day }} - <span class="text-primary">{{ workout.title if workout and
                            workout.title else 'No Title' }}</span></h5>
                    <small class="text-muted">
                        {{ (start_of_week + timedelta(days=loop.index0)).strftime('%B %d') }}
                    </small>
                </div>
            </div>
            <div class="card-body">
                {% if workout and not workout.is_rest_day %}
                {% if workout.tasks %}
                <!-- Progress Bar (now based on sets) -->
                {% set total_sets = namespace(count=0) %}
                {% set completed_sets = namespace(count=0) %}
                {% for task in workout.tasks %}
                {% if task.sets is iterable and (task.sets is not string and task.sets is not mapping) %}
                {% set total_sets.count = total_sets.count + (task.sets|length) %}
                {% for s in task.sets %}{% if s.completed %}{% set completed_sets.count = completed_sets.count + 1 %}{%
                endif %}{% endfor %}
                {% endif %}
                {% endfor %}
                {% set progress = (completed_sets.count / total_sets.count * 100) if total_sets.count > 0 else 0 %}
                <div class="progress mb-3" style="height: 20px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ progress }}%;"
                        aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">{{ completed_sets.count }}
                        / {{
                        total_sets.count }}</div>
                </div>

                <ul class="list-group list-group-flush">
                    {% for task in workout.tasks %}
                    <li class="list-group-item bg-transparent">
                        {% if task.sets is iterable and (task.sets is not string and task.sets is not mapping) %}
                        {# New data structure: 'sets' is a list of objects #}
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <strong>{{ task.exercise_name }}</strong>: {{ task.sets|length }} sets of {{
                                task.target_reps }} reps
                            </span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary edit-exercise-btn"
                                    data-bs-toggle="modal" data-bs-target="#editExerciseModal"
                                    data-workout-id="{{ workout._id }}" data-task-id="{{ task._id }}"
                                    data-exercise-id="{{ task.exercise_id }}" data-sets="{{ task.sets|length }}"
                                    data-reps="{{ task.target_reps }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-task-btn" data-bs-toggle="modal"
                                    data-bs-target="#deleteConfirmationModal" data-workout-id="{{ workout._id }}"
                                    data-task-id="{{ task._id }}">
                                    <i class="fas fa-trash-alt"></i> Delete</button>
                            </div>
                        </div>
                        <ul class="list-group list-group-flush mt-2">
                            {% for set_item in task.sets %}
                            <li class="list-group-item bg-transparent d-flex align-items-center ps-4">
                                <span class="me-3">Set {{ set_item.set_number }}</span>
                                <div class="input-group input-group-sm me-2" style="width: 120px;">
                                    <input type="text" class="form-control set-detail-input" placeholder="Weight"
                                        data-field="weight_kg" value="{{ set_item.weight_kg or '' }}"
                                        data-workout-id="{{ workout._id }}" data-task-id="{{ task._id }}"
                                        data-set-id="{{ set_item._id }}">
                                    <span class="input-group-text">kg</span>
                                </div>
                                <div class="input-group input-group-sm me-auto" style="width: 100px;">
                                    <input type="text" class="form-control set-detail-input" placeholder="Reps"
                                        data-field="actual_reps" value="{{ set_item.actual_reps or '' }}"
                                        data-workout-id="{{ workout._id }}" data-task-id="{{ task._id }}"
                                        data-set-id="{{ set_item._id }}">
                                    <span class="input-group-text">reps</span>
                                </div>
                                <input class="form-check-input set-checkbox" type="checkbox"
                                    data-workout-id="{{ workout._id }}" data-task-id="{{ task._id }}"
                                    data-set-id="{{ set_item._id }}" {% if set_item.completed %}checked{% endif %}>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        {# Old data structure: 'sets' is an integer #}
                        <strong>{{ task.exercise_name }}</strong>: {{ task.sets }} sets of {{ task.reps }} reps
                        <p class="text-muted small ps-4"> (Old format, please re-add to track individual sets) </p>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No exercises scheduled.</p>
                {% endif %}
                {% elif day == 'Sunday' or (workout and workout.is_rest_day) %}
                {% if workout and workout.notes %}
                <div class="fst-italic text-muted border-top pt-2 mt-2">
                    <strong>Notes:</strong> {{ workout.notes }}
                </div>
                {% endif %}
                <p class="text-success fw-bold">Rest Day</p>
                {% else %}
                <p class="text-muted">No exercises scheduled.</p>
                {% endif %}
            </div>
            {% if day != 'Sunday' %}
            <div class="card-footer">
                <!-- Placeholder for Add Exercise Form/Button -->
                <button class="btn btn-sm btn-outline-secondary edit-day-btn" data-bs-toggle="modal"
                    data-bs-target="#editDayModal"
                    data-date="{{ (start_of_week + timedelta(days=loop.index0)).isoformat() }}"
                    data-notes="{{ workout.notes if workout else '' }}"
                    data-title="{{ workout.title if workout else '' }}"
                    data-is-rest-day="{{ 'true' if workout and workout.is_rest_day else 'false' }}">Edit Day</button>
                <button class="btn btn-sm btn-outline-primary add-exercise-btn" data-bs-toggle="modal"
                    data-bs-target="#addExerciseModal"
                    data-date="{{ (start_of_week + timedelta(days=loop.index0)).isoformat() }}">Add</button>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock main_content %}

{% block body_end_scripts %}
{{ super() }}
<!-- Edit Day Modal -->
<div class="modal fade" id="editDayModal" tabindex="-1" aria-labelledby="editDayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('edit_workout_day') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="editDayModalLabel">Edit Day</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="edit_workout_date" id="edit_workout_date">
                    <div class="mb-3">
                        <label for="day_title" class="form-label">Day Title (e.g., Push Day, Leg Day)</label>
                        <input type="text" class="form-control" name="day_title" id="day_title"
                            placeholder="e.g., Leg Day">
                    </div>
                    <div class="mb-3">
                        <label for="day_notes" class="form-label">Notes for the day (optional)</label>
                        <textarea class="form-control" name="day_notes" id="day_notes" rows="3"
                            placeholder="e.g., Felt tired, focused on form..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_rest_day" id="is_rest_day">
                        <label class="form-check-label" for="is_rest_day">
                            Mark as Rest Day
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>



<!-- Add Exercise Modal -->
<div class="modal fade" id="addExerciseModal" tabindex="-1" aria-labelledby="addExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_exercise_to_day') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="addExerciseModalLabel">Add Exercise</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="workout_date" id="workout_date">
                    <div class="mb-3">
                        <label for="exercise_id" class="form-label">Exercise</label>
                        <select class="form-select" name="exercise_id" id="exercise_id" required>
                            <option selected disabled value="">Choose...</option>
                            {% for exercise in all_exercises %}
                            <option value="{{ exercise._id }}">{{ exercise.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sets" class="form-label">Sets</label>
                        <input type="number" class="form-control" name="sets" id="sets" required>
                    </div>
                    <div class="mb-3">
                        <label for="reps" class="form-label">Reps</label>
                        <input type="text" class="form-control" name="reps" id="reps" placeholder="e.g., 8-12" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Exercise</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Exercise Modal -->
<div class="modal fade" id="editExerciseModal" tabindex="-1" aria-labelledby="editExerciseModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('edit_exercise') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="editExerciseModalLabel">Edit Exercise</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="edit_workout_day_id" id="edit_workout_day_id">
                    <input type="hidden" name="edit_task_id" id="edit_task_id">
                    <div class="mb-3">
                        <label for="edit_exercise_id" class="form-label">Exercise</label>
                        <select class="form-select" name="edit_exercise_id" id="edit_exercise_id" required>
                            <option disabled value="">Choose...</option>
                            {% for exercise in all_exercises %}
                            <option value="{{ exercise._id }}">{{ exercise.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_sets" class="form-label">Sets</label>
                        <input type="number" class="form-control" name="edit_sets" id="edit_sets" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_reps" class="form-label">Reps</label>
                        <input type="text" class="form-control" name="edit_reps" id="edit_reps" placeholder="e.g., 8-12"
                            required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this exercise? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        var addExerciseModal = document.getElementById('addExerciseModal');
        addExerciseModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var workoutDate = button.getAttribute('data-date'); // Extract info from data-* attributes
            var modalDateField = addExerciseModal.querySelector('#workout_date');
            modalDateField.value = workoutDate;
        });

        var editDayModal = document.getElementById('editDayModal');
        editDayModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var workoutDate = button.getAttribute('data-date');
            var currentTitle = button.getAttribute('data-title');
            var currentNotes = button.getAttribute('data-notes');
            var isRestDay = button.getAttribute('data-is-rest-day') === 'true';

            var modalDateField = editDayModal.querySelector('#edit_workout_date');
            var modalTitleField = editDayModal.querySelector('#day_title');
            var modalNotesField = editDayModal.querySelector('#day_notes');
            var modalRestDayCheckbox = editDayModal.querySelector('#is_rest_day');

            modalDateField.value = workoutDate;
            modalTitleField.value = currentTitle;
            modalNotesField.value = currentNotes;
            modalRestDayCheckbox.checked = isRestDay;
        });

        var editExerciseModal = document.getElementById('editExerciseModal');
        editExerciseModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            // Populate hidden fields
            document.getElementById('edit_workout_day_id').value = button.dataset.workoutId;
            document.getElementById('edit_task_id').value = button.dataset.taskId;

            // Populate visible form fields
            document.getElementById('edit_exercise_id').value = button.dataset.exerciseId;
            document.getElementById('edit_sets').value = button.dataset.sets;
            document.getElementById('edit_reps').value = button.dataset.reps;
        });






        // Handle set completion checkboxes
        document.querySelectorAll('.set-checkbox').forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                const workoutId = this.dataset.workoutId;
                const taskId = this.dataset.taskId;
                const setId = this.dataset.setId;
                const isCompleted = this.checked;

                // Update progress bar immediately
                const cardBody = this.closest('.card');
                const progressBar = cardBody.querySelector('.progress-bar');
                const allCheckboxes = cardBody.querySelectorAll('.set-checkbox');
                const totalSets = allCheckboxes.length;
                const completedSets = Array.from(allCheckboxes).filter(cb => cb.checked).length;
                const newProgress = totalSets > 0 ? (completedSets / totalSets * 100) : 0;

                progressBar.style.width = newProgress + '%';
                progressBar.textContent = `${completedSets} / ${totalSets}`;
                progressBar.setAttribute('aria-valuenow', newProgress);

                // Send update to the server
                fetch("{{ url_for('toggle_set_completion') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        workout_day_id: workoutId,
                        task_id: taskId,
                        set_id: setId,
                        is_completed: isCompleted
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status !== 'success') {
                            console.error('Failed to update set:', data.message);
                            // Optional: revert checkbox and show an error message
                            this.checked = !isCompleted;
                            // You might want to re-calculate and update the progress bar here as well
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        });

        // Handle task deletion
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        let workoutIdToDelete, taskIdToDelete;

        // 1. When the modal is about to be shown, store the relevant IDs
        deleteConfirmationModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Button that triggered the modal
            workoutIdToDelete = button.dataset.workoutId;
            taskIdToDelete = button.dataset.taskId;
        });

        // 2. When the confirm delete button is clicked, perform the fetch
        confirmDeleteBtn.addEventListener('click', function () {
            fetch("{{ url_for('delete_task') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    workout_day_id: workoutIdToDelete,
                    task_id: taskIdToDelete,
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Find the task item in the DOM and remove it
                        const taskListItem = document.querySelector(`.delete-task-btn[data-task-id="${taskIdToDelete}"]`).closest('.list-group-item');
                        if (taskListItem) {
                            taskListItem.remove();
                        }
                        // Hide the modal
                        const modal = bootstrap.Modal.getInstance(deleteConfirmationModal);
                        modal.hide();
                    } else {
                        console.error('Failed to delete task:', data.message);
                        alert('Error: Could not delete the exercise.');
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    });
</script>
{% endblock %}